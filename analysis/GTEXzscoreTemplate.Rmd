---
title: "Template for GTEx example on cluster"
author: "wei"
date: 09-29
output: html_document
---

<!-- The file analysis/chunks.R contains chunks that define default settings
shared across the workflowr files. -->
```{r read-chunk, include=FALSE, cache=FALSE}
knitr::read_chunk("chunks.R")
```

<!-- Update knitr chunk options -->
```{r knitr-opts-chunk, include=FALSE}
```

<!-- Insert the date the file was last updated -->
```{r last-updated, echo=FALSE, results='asis'}
```

<!-- Insert the code version (Git commit SHA1) if Git repository exists and R
 package git2r is installed -->
```{r code-version, echo=FALSE, results='asis'}
```

<!-- Add your analysis here -->

## Install the package

1 please git clone the `flashr2` on PPS.

`git clone https://github.com/stephenslab/flashr2.git`

2 install `flashr2` locally

`R CMD build flashr2`

`R CMD INSTALL flashr2_0.2-2.tar.gz`


## prepare the data

### original data 

Please read your original data as a $N \times P$ matrix in R.

In this case you can create a folder the restore the data as `.rds` file

```
mkdir testflashr2
cd testflashr2
cp gtexEQTL_zscore.rds GTEX/testflashr2/
```

now you have the data matrix in `gtexEQTL_zscore.rds`

to restore the result and track the errors, you can crest folders

```
mkdir output
mkdir ourlog
```

## run FLASH

Here I take the GTEx EQTL zscore as an example

### creat a .R file

```
library(ashr)
library(flashr2)
load("./gtexEQTL_zscore.rds")
Y = t(zscore)
data = flash_set_data(Y)
f_greedy = flash_add_greedy(data,Kmax=60)
f_greedy_bf = flash_backfit(data,f_greedy)
#f_greedy = flash_add_greedy(data,Kmax=60,var_type = "by_column",ash_param=list(method = "fdr"))
#f_greedy_bf = flash_backfit(data,f_greedy,var_type = "by_column",ash_param=list(method = "fdr"))
saveRDS(f_greedy,file = "./output/gflashvarcol.rds")
saveRDS(f_greedy_bf,file = "./output/bflashvarcol.rds")
```

here 60 is much larger than the sample size. our method doesn't restrict $K < \min(P,N)$. But for this case, 60 is enough. We call this file as `flashwrapper.R`

### creat a .sbatch file

```
#!/bin/bash

#SBATCH --job-name=arrayJob
#SBATCH --output=/home/weidong/HG/flash/data/GTEX/testflashr2/outlog/arrayJob_%A_%a.out
#SBATCH --error=/home/weidong/HG/flash/data/GTEX/testflashr2/outlog/arrayJob_%A_%a.err
#SBATCH --array=1
#SBATCH --time=30:00:00
#SBATCH --partition=mstephens
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=1
#SBATCH --mem-per-cpu=8G


######################
# Begin work section #
######################

# Print this sub-job's task ID
cd /home/weidong/HG/flash/data/GTEX/testflashr2
Rscript --verbose flashwrapper.R
```

you can substitute the folder path `/home/weidong/HG/flash/data/GTEX/testflashr2`. and we call this `.sbatch` file as `runflash.sbatch`

## run 

```
sbatch runflash.sbatch 
```

## plot

```{}
b_flash = readRDS("../data/GTExdata/res_flashr2/bflashvarcol.rds")
load("../data/GTExdata/gtexEQTL_zscore.rds")
ssY = sum(zscore^2)
K = dim(b_flash$EL)[2] -1
pve = (sapply(seq(1,K),function(x){ sum(b_flash$EL[,x]^2 %*% t(b_flash$EF[,x]^2)) }))/ssY
pve = pmax(round(pve,3),0.001)

dat = read.table('../data/GTExColors.txt', sep = '\t', comment.char = '')
colordata = dat[c(1:6,9:18,21:23,26:30,32,33,35,36,38:53),1:2]

L = b_flash$EL[,1:14]
library(reshape2)
data_L = melt(L)
colnames(data_L) = c("tissue","loading","value")
library(ggplot2)
tissue_color = as.character(colordata[,2])
data_L$tissue = factor(data_L$tissue,levels = 1:44 ,labels = as.character(colordata[,1]) )
data_L$loading = factor(data_L$loading,levels = 1:14 ,labels = paste("loading",1:14,"; pve:", pve[1:14]))


ggplot(data_L,aes(x = tissue,y = value,fill = factor(tissue) )) +
  geom_bar(stat = "identity",width = 0.6) +
  scale_fill_manual(values=tissue_color) +
  scale_x_discrete(labels = NULL) +
  theme_grey()+
  theme(legend.position="right", legend.text=element_text(size=5), axis.text.y = element_text(size = 5)) + 
  labs(title = "GTEx data", y = "loading values" ,x = "tissues", fill="tissue") +
  facet_wrap(~loading, ncol = 2, scales = "free_y") +
  guides(fill = guide_legend(ncol = 1, keyheight = 0.5, keywidth = 0.5))
  ggsave("flashr2GTEx1.pdf", width = 8, height = 11)

# the 27th factor is zero
L = b_flash$EL[,15:26]
library(reshape2)
data_L = melt(L)
colnames(data_L) = c("tissue","loading","value")
library(ggplot2)
tissue_color = as.character(colordata[,2])
data_L$tissue = factor(data_L$tissue,levels = 1:44 ,labels = as.character(colordata[,1]) )
data_L$loading = factor(data_L$loading,levels = 1:12 ,labels = paste("loading",15:26,"; pve:", pve[15:26]))


ggplot(data_L,aes(x = tissue,y = value,fill = factor(tissue) )) +
  geom_bar(stat = "identity",width = 0.6) +
  scale_fill_manual(values=tissue_color) +
  scale_x_discrete(labels = NULL) +
  theme_grey()+
  theme(legend.position="right", legend.text=element_text(size=5), axis.text.y = element_text(size = 5)) + 
  labs(title = "GTEx data", y = "loading values" ,x = "tissues", fill="tissue") +
  facet_wrap(~loading, ncol = 2, scales = "free_y") +
  guides(fill = guide_legend(ncol = 1, keyheight = 0.5, keywidth = 0.5))
  ggsave("flashr2GTEx2.pdf", width = 8, height = 10)
```


the plots are

[plot1](https://github.com/NKweiwang/flash_workflow/blob/master/analysis/flashr2GTEx1.pdf)

[plot2](https://github.com/NKweiwang/flash_workflow/blob/master/analysis/flashr2GTEx2.pdf)

## Session information

<!-- Insert the session information into the document -->
```{r session-info}
```
